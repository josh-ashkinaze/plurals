
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Best-of-N Response Selection &#8212; Plurals  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorial_6_best_of_n';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Interview-Based Personas" href="tutorial_7_interview.html" />
    <link rel="prev" title="Moderators" href="tutorial_5_moderators.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Plurals  documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tutorial_1_core.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_2_quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_3_agents.html">Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_4_structures.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_5_moderators.html">Moderators</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Best-of-N Response Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_7_interview.html">Interview-Based Personas</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="agent.html">Agent Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="deliberation.html">Deliberation Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="helpers.html">Helpers Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="interview.html">Interview Module</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/tutorial_6_best_of_n.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Best-of-N Response Selection</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-start">Quick Start</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-return-first-response-learn-the-mechanics">Example 1: Return First Response (Learn the Mechanics)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-return-longest-response">Example 2: Return Longest Response</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-a-real-world-problem-wikipedia-npov-with-verifiable-metrics">Example 3: [A real-world problem] Wikipedia NPOV with verifiable metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installation">Installation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#strategy-a-minimize-edit-distance">Strategy A: Minimize Edit Distance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#strategy-b-maximize-semantic-similarity">Strategy B: Maximize Semantic Similarity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#strategy-c-mixture-of-rewards">Strategy C: Mixture of Rewards</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-4-llm-as-judge-for-single-agents">Example 4: LLM-as-Judge for Single Agents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-5-llm-as-judge-in-debates">Example 5: LLM-as-Judge in Debates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pitfalls">Common Pitfalls</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="best-of-n-response-selection">
<span id="best-of-n"></span><h1>Best-of-N Response Selection<a class="headerlink" href="#best-of-n-response-selection" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>Agents support generating multiple responses and selecting the best one according to a user-defined function. This enables techniques like self-consistency sampling and reward optimizing.</p>
<p>Two required parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">num_responses</span></code>: Number of responses to generate (must be ≥ 1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">response_selector</span></code>: Function that takes a list of strings and returns one string</p></li>
</ul>
<p>All generated responses are stored in <code class="docutils literal notranslate"><span class="pre">agent.history[-1]['all_responses']</span></code> for inspection.</p>
</section>
<section id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Link to this heading">#</a></h2>
<p>The examples below progress from simple to advanced:</p>
<ol class="arabic simple">
<li><p><strong>Return first response</strong>: Learn the basic mechanics</p></li>
<li><p><strong>Return longest response</strong>: Simple heuristic-based selection</p></li>
<li><p><strong>Wikipedia NPOV</strong>: Verifiable rewards (edit distance, semantic similarity, mixed rewards)</p></li>
<li><p><strong>LLM-as-judge</strong>: Complex behavioral criteria for single agents</p></li>
<li><p><strong>LLM-as-judge in debates</strong>: Maximize adherence across multi-turn interactions</p></li>
</ol>
</section>
<section id="example-1-return-first-response-learn-the-mechanics">
<h2>Example 1: Return First Response (Learn the Mechanics)<a class="headerlink" href="#example-1-return-first-response-learn-the-mechanics" title="Link to this heading">#</a></h2>
<p>Start by understanding the basic pattern—generate multiple responses but just return the first one.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">plurals.agent</span> <span class="kn">import</span> <span class="n">Agent</span>

<span class="k">def</span> <span class="nf">return_first</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Always return the first response&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">task</span><span class="o">=</span><span class="s2">&quot;Explain photosynthesis in simple terms&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="n">return_first</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Inspect what was generated:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">all_responses</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;all_responses&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_responses</span><span class="p">)</span><span class="si">}</span><span class="s2"> responses:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_responses</span><span class="p">):</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="s2">&quot;← SELECTED&quot;</span> <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">response</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">r</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span><span class="si">}</span><span class="s2">... </span><span class="si">{</span><span class="n">selected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Output:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Generated 5 responses:
1. Photosynthesis is the process by which green plants, algae, and some bacteria co... ← SELECTED
2. Photosynthesis is the process by which green plants, algae, and some bacteria co...
3. Photosynthesis is a process that plants, algae, and some bacteria use to make th...
4. Photosynthesis is the process by which green plants, algae, and some bacteria ma...
5. Photosynthesis is the process by which green plants, algae, and some bacteria co...
</pre></div>
</div>
<p>So, the agent generated 5 different responses, but <code class="docutils literal notranslate"><span class="pre">return_first</span></code> selected the first one. Now you can write more sophisticated selectors.</p>
</section>
<section id="example-2-return-longest-response">
<h2>Example 2: Return Longest Response<a class="headerlink" href="#example-2-return-longest-response" title="Link to this heading">#</a></h2>
<p>Pick the most detailed response using a simple heuristic.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">plurals.agent</span> <span class="kn">import</span> <span class="n">Agent</span>

<span class="k">def</span> <span class="nf">pick_longest</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the response with the most characters&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">task</span><span class="o">=</span><span class="s2">&quot;Explain photosynthesis&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="n">pick_longest</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Inspect with lengths:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">all_responses</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;all_responses&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_responses</span><span class="p">):</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="s2">&quot;← SELECTED&quot;</span> <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">response</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2"> chars) </span><span class="si">{</span><span class="n">r</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span><span class="si">}</span><span class="s2">... </span><span class="si">{</span><span class="n">selected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Output:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>1. (131 chars) Photosynthesis converts light energy into chemical energy, using sunlight, carbo...
2. (136 chars) Photosynthesis converts sunlight into chemical energy, using carbon dioxide and ... ← SELECTED
3. (133 chars) Photosynthesis converts sunlight, carbon dioxide, and water into glucose and oxy...
4. (133 chars) Photosynthesis converts sunlight, water, and carbon dioxide into glucose and oxy...
5. (127 chars) Photosynthesis is the process where plants convert sunlight, carbon dioxide, and...
</pre></div>
</div>
<p><strong>Also useful</strong>: Pick the <em>shortest</em> response for concise answers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">task</span><span class="o">=</span><span class="s2">&quot;Say hello creatively&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="k">lambda</span> <span class="n">responses</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-3-a-real-world-problem-wikipedia-npov-with-verifiable-metrics">
<h2>Example 3: [A real-world problem] Wikipedia NPOV with verifiable metrics<a class="headerlink" href="#example-3-a-real-world-problem-wikipedia-npov-with-verifiable-metrics" title="Link to this heading">#</a></h2>
<p><strong>Problem</strong>:
When asked to neutralize biased text (e.g., for Wikipedia’s Neutral Point of View policy), LLMs often deviate from the way expert editors make changes [1]. We found that LLMs rewrite entire sentences when human editors would make minimal edits like removing one or two charged words.</p>
<p><strong>Solution</strong>:
Generate multiple neutralizations and select based on verifiable metrics: edit distance, semantic similarity, or a mixture of both.</p>
<p>[1] Ashkinaze, J., Guan, R., Kurek, L., Adar, E., Budak, C., &amp; Gilbert, E. (2024). Seeing like an ai: How llms apply (and misapply) wikipedia neutrality norms. arXiv preprint arXiv:2407.04183.</p>
<section id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Link to this heading">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>editdistance<span class="w"> </span>sentence-transformers
</pre></div>
</div>
</section>
<section id="strategy-a-minimize-edit-distance">
<h3>Strategy A: Minimize Edit Distance<a class="headerlink" href="#strategy-a-minimize-edit-distance" title="Link to this heading">#</a></h3>
<p><strong>When to use</strong>: Preserving the original wording and structure is critical (e.g., Wikipedia edits, legal documents).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">plurals.agent</span> <span class="kn">import</span> <span class="n">Agent</span>
<span class="kn">import</span> <span class="nn">editdistance</span>

<span class="n">original_text</span> <span class="o">=</span> <span class="s2">&quot;He was a very, very good photographer. He also had to go to school, where he flourished achieving praise from his teachers.&quot;</span>

<span class="k">def</span> <span class="nf">small_edit_dist</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">original</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return response with minimal edit distance to original&quot;&quot;&quot;</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">editdistance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">]</span>
    <span class="n">min_distance_idx</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">distances</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">responses</span><span class="p">[</span><span class="n">min_distance_idx</span><span class="p">]</span>

<span class="n">neutralizer</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Neutralize this statement: </span><span class="si">{</span><span class="n">original_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">small_edit_dist</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">original_text</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">neutralizer</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original:    </span><span class="si">{</span><span class="n">original_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Neutralized: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edit distance: </span><span class="si">{</span><span class="n">editdistance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">original_text</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Output:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Original:    He was a very, very good photographer. He also had to go to school, where he flourished achieving praise from his teachers.
Neutralized: He was a competent photographer and attended school, where he received feedback from his teachers.
Edit distance: 52
</pre></div>
</div>
<p><strong>Inspect all alternatives:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">all_responses</span> <span class="o">=</span> <span class="n">neutralizer</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;all_responses&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">All neutralizations ranked by edit distance:&quot;</span><span class="p">)</span>
<span class="n">scored_responses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_responses</span><span class="p">:</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">editdistance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">original_text</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="n">scored_responses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dist</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>

<span class="n">scored_responses</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scored_responses</span><span class="p">):</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="s2">&quot;← SELECTED&quot;</span> <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">response</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. (dist=</span><span class="si">{</span><span class="n">dist</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">selected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Output:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>All neutralizations ranked by edit distance:
1. (dist=52) He was a competent photographer and attended school, where he received feedback from his teachers. ← SELECTED
2. (dist=53) He was a competent photographer who attended school, where he received some recognition from his teachers.
3. (dist=58) He was a competent photographer who attended school, where he received some positive feedback from his teachers.
4. (dist=58) He was a competent photographer who attended school, where he received some positive feedback from his teachers.
5. (dist=72) He was a photographer who demonstrated competence in his craft. He attended school, where he received feedback from his teachers.
</pre></div>
</div>
<p>So in some cases you can imagine an LLM making a bunch of edits like Example 5.</p>
</section>
<section id="strategy-b-maximize-semantic-similarity">
<h3>Strategy B: Maximize Semantic Similarity<a class="headerlink" href="#strategy-b-maximize-semantic-similarity" title="Link to this heading">#</a></h3>
<p>But let’s say we really just want to preserve meaning and don’t care as much about exact wording (e.g., paraphrasing with neutralization).
Here we can use SBERT or some kind of embedding model. The point of this example is really that you can use models optimized for
specific tasks (in this case semantic similarity) to guide best-of-n selection for different Agents.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cosine</span>

<span class="c1"># Load embedding model (do this once, reuse across agents)</span>
<span class="n">embedding_model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;all-MiniLM-L6-v2&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">max_semantic_similarity</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return response most semantically similar to original&quot;&quot;&quot;</span>
    <span class="n">original_embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">original</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">similarities</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="n">r_embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">r</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">similarity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cosine</span><span class="p">(</span><span class="n">original_embedding</span><span class="p">,</span> <span class="n">r_embedding</span><span class="p">)</span>
        <span class="n">similarities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">similarity</span><span class="p">)</span>

    <span class="n">max_sim_idx</span> <span class="o">=</span> <span class="n">similarities</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">similarities</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">responses</span><span class="p">[</span><span class="n">max_sim_idx</span><span class="p">]</span>

<span class="n">neutralizer</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Neutralize the statement: </span><span class="si">{</span><span class="n">original_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">},</span>  <span class="c1"># Higher temp for diversity</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">max_semantic_similarity</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">original_text</span><span class="p">,</span> <span class="n">embedding_model</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">neutralizer</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="strategy-c-mixture-of-rewards">
<h3>Strategy C: Mixture of Rewards<a class="headerlink" href="#strategy-c-mixture-of-rewards" title="Link to this heading">#</a></h3>
<p><strong>When to use</strong>: Best of both worlds for Wikipedia NPOV—both minimal changes AND preserved meaning.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mixed_score_selector</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select response optimizing both edit distance and semantic similarity.</span>

<span class="sd">    Args:</span>
<span class="sd">        responses: List of candidate responses</span>
<span class="sd">        original: Original text</span>
<span class="sd">        model: Sentence embedding model</span>
<span class="sd">        alpha: Weight for edit distance (1-alpha for semantic similarity)</span>
<span class="sd">               alpha=1.0 means only edit distance</span>
<span class="sd">               alpha=0.0 means only semantic similarity</span>
<span class="sd">               alpha=0.5 means equal weighting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">original</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Normalize edit distances to [0, 1] range</span>
    <span class="n">edit_distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">editdistance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">]</span>
    <span class="n">max_dist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">edit_distances</span><span class="p">)</span> <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">edit_distances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">normalized_dists</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="o">/</span> <span class="n">max_dist</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">edit_distances</span><span class="p">]</span>

    <span class="c1"># Calculate semantic similarities (already in [0, 1])</span>
    <span class="n">similarities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="n">r_embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">r</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">similarity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cosine</span><span class="p">(</span><span class="n">original_embedding</span><span class="p">,</span> <span class="n">r_embedding</span><span class="p">)</span>
        <span class="n">similarities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">similarity</span><span class="p">)</span>

    <span class="c1"># Combined score (lower edit distance is better, higher similarity is better)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">norm_dist</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">normalized_dists</span><span class="p">,</span> <span class="n">similarities</span><span class="p">):</span>
        <span class="n">combined_score</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">sim</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">norm_dist</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_score</span><span class="p">)</span>

    <span class="n">max_score_idx</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">responses</span><span class="p">[</span><span class="n">max_score_idx</span><span class="p">]</span>

<span class="c1"># Equal weighting (alpha=0.5)</span>
<span class="n">neutralizer</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Neutralize the sentiment: </span><span class="si">{</span><span class="n">original_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">},</span>  <span class="c1"># Higher temp for diversity</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">mixed_score_selector</span><span class="p">(</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">original_text</span><span class="p">,</span> <span class="n">embedding_model</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">neutralizer</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Compare all metrics:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">all_responses</span> <span class="o">=</span> <span class="n">neutralizer</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;all_responses&#39;</span><span class="p">]</span>
<span class="n">original_embedding</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">original_text</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">edit_distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">editdistance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">original_text</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_responses</span><span class="p">]</span>
<span class="n">max_dist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">edit_distances</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">All neutralizations with mixed scoring (alpha=0.5):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Rank&#39;</span><span class="si">:</span><span class="s2">&lt;6</span><span class="si">}{</span><span class="s1">&#39;Edit Dist&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}{</span><span class="s1">&#39;Similarity&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}{</span><span class="s1">&#39;Combined&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2">Response&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

<span class="n">scored_responses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_responses</span><span class="p">:</span>
    <span class="n">edit_dist</span> <span class="o">=</span> <span class="n">editdistance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">original_text</span><span class="p">)</span>
    <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">edit_dist</span> <span class="o">/</span> <span class="n">max_dist</span>

    <span class="n">r_embedding</span> <span class="o">=</span> <span class="n">embedding_model</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">r</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cosine</span><span class="p">(</span><span class="n">original_embedding</span><span class="p">,</span> <span class="n">r_embedding</span><span class="p">)</span>

    <span class="n">combined</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">similarity</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">norm_dist</span>

    <span class="n">scored_responses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">combined</span><span class="p">,</span> <span class="n">edit_dist</span><span class="p">,</span> <span class="n">similarity</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>

<span class="n">scored_responses</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scored_responses</span><span class="p">):</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="s2">&quot;← SELECTED&quot;</span> <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">response</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">&lt;6</span><span class="si">}{</span><span class="n">dist</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}{</span><span class="n">sim</span><span class="si">:</span><span class="s2">&lt;12.3f</span><span class="si">}{</span><span class="n">combined</span><span class="si">:</span><span class="s2">&lt;12.3f</span><span class="si">}{</span><span class="n">r</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">selected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Output:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>All neutralizations with mixed scoring (alpha=0.5):
Rank  Edit Dist   Similarity  Combined    Response
--------------------------------------------------------------------------------
1     50          0.896       0.105       He was a capable photographer. He attended school, where he received feedback from his teachers. ← SELECTED
2     53          0.895       0.085       He was a competent photographer and attended school, where he received some recognition from his teachers.
3     52          0.855       0.071       He was a photographer. He attended school, where he received feedback from his teachers.
4     70          0.908       -0.025      He was a competent photographer. He attended school, where he performed adequately and received some recognition from his teachers.
5     73          0.846       -0.077      He was a photographer who met the expectations of his training. He attended school, where he received feedback from his teachers.
</pre></div>
</div>
</section>
</section>
<section id="example-4-llm-as-judge-for-single-agents">
<h2>Example 4: LLM-as-Judge for Single Agents<a class="headerlink" href="#example-4-llm-as-judge-for-single-agents" title="Link to this heading">#</a></h2>
<p><strong>Setup evaluator:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">plurals.agent</span> <span class="kn">import</span> <span class="n">Agent</span>

<span class="n">formality_evaluator</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">system_instructions</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Rate how formal and professional this text is:</span>
<span class="s2">    - Uses appropriate business language</span>
<span class="s2">    - Avoids slang and casual phrasing</span>
<span class="s2">    - Maintains professional tone</span>
<span class="s2">    - Uses complete sentences</span>

<span class="s2">    Return ONLY a number from 0-10.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span>  <span class="c1"># Use cheap model for evaluation</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Create selection function:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pick_most_formal</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use LLM to pick most formal response&quot;&quot;&quot;</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="n">score_str</span> <span class="o">=</span> <span class="n">formality_evaluator</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rate this text:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score_str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Fallback if parsing fails</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">responses</span><span class="p">[</span><span class="n">scores</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">))]</span>
</pre></div>
</div>
<p>Here it’s scoring each response but we can just as easily have the LLM directly return the top one. But there is a chance,
the LLM could return an invalid response in that case and hallucinate—though one can ensure the response does
exist in the input list.</p>
<p><strong>Use with agent:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">task</span><span class="o">=</span><span class="s2">&quot;Explain why the project deadline was missed&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="n">pick_most_formal</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>  <span class="c1"># Higher temperature for diversity</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-5-llm-as-judge-in-debates">
<h2>Example 5: LLM-as-Judge in Debates<a class="headerlink" href="#example-5-llm-as-judge-in-debates" title="Link to this heading">#</a></h2>
<p><strong>Use case</strong>: Maximize adherence to instructions across multi-turn debates (good faith vs. bad faith) with Agents who
are supposed to follow different goals.</p>
<p><strong>Setup evaluators:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">plurals.agent</span> <span class="kn">import</span> <span class="n">Agent</span>
<span class="kn">from</span> <span class="nn">plurals.deliberation</span> <span class="kn">import</span> <span class="n">Debate</span>

<span class="n">good_faith_evaluator</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">system_instructions</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Rate how well this response demonstrates good-faith debate:</span>
<span class="s2">    - Directly addresses opponent&#39;s actual arguments</span>
<span class="s2">    - Acknowledges valid points</span>
<span class="s2">    - Uses honest reasoning</span>
<span class="s2">    - Seeks truth over winning</span>

<span class="s2">    Return ONLY a number from 0-10.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span>
<span class="p">)</span>

<span class="n">bad_faith_evaluator</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">system_instructions</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Rate how well this response demonstrates bad-faith debate:</span>
<span class="s2">    - Misrepresents opponent&#39;s arguments</span>
<span class="s2">    - Uses deflection and whataboutism</span>
<span class="s2">    - Makes ad hominem attacks</span>
<span class="s2">    - Focuses on winning over truth</span>

<span class="s2">    Return ONLY a number from 0-10.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Create selection functions:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pick_most_good_faith</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use LLM to pick most good-faith response&quot;&quot;&quot;</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="n">score_str</span> <span class="o">=</span> <span class="n">good_faith_evaluator</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
            <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rate this debate response:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score_str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">responses</span><span class="p">[</span><span class="n">scores</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">))]</span>

<span class="k">def</span> <span class="nf">pick_most_bad_faith</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use LLM to pick most bad-faith response&quot;&quot;&quot;</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="n">score_str</span> <span class="o">=</span> <span class="n">bad_faith_evaluator</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
            <span class="n">task</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rate this debate response:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score_str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">responses</span><span class="p">[</span><span class="n">scores</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">))]</span>
</pre></div>
</div>
<p><strong>Full debate with greedy best-of-n:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">good_faith_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">system_instructions</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You debate in good faith. Address arguments directly,</span>
<span class="s2">    acknowledge valid points, seek truth over winning.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="n">pick_most_good_faith</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">bad_faith_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">system_instructions</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You debate in bad faith. Misrepresent arguments,</span>
<span class="s2">    use strawman tactics, deflect, focus on winning.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="n">pick_most_bad_faith</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">debate</span> <span class="o">=</span> <span class="n">Debate</span><span class="p">(</span>
    <span class="n">agents</span><span class="o">=</span><span class="p">[</span><span class="n">good_faith_agent</span><span class="p">,</span> <span class="n">bad_faith_agent</span><span class="p">],</span>
    <span class="n">task</span><span class="o">=</span><span class="s2">&quot;Should social media be regulated by government? Answer in 200 words on each turn.&quot;</span><span class="p">,</span>
    <span class="n">combination_instructions</span><span class="o">=</span><span class="s2">&quot;debate&quot;</span><span class="p">,</span>
    <span class="n">cycles</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>

<span class="n">debate</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

<span class="c1"># Print debate transcript</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">debate</span><span class="o">.</span><span class="n">responses</span><span class="p">):</span>
    <span class="n">agent_label</span> <span class="o">=</span> <span class="s2">&quot;Good Faith&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Bad Faith&quot;</span>
    <span class="n">turn</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">80</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">agent_label</span><span class="si">}</span><span class="s2"> - Turn </span><span class="si">{</span><span class="n">turn</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">80</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="common-pitfalls">
<h2>Common Pitfalls<a class="headerlink" href="#common-pitfalls" title="Link to this heading">#</a></h2>
<p><strong>Missing response_selector:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ERROR - Will raise exception</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># CORRECT</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">response_selector</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p><strong>Selector returns None:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># BAD - Can return None</span>
<span class="k">def</span> <span class="nf">broken</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;keyword&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>
    <span class="c1"># Returns None if keyword not found!</span>

<span class="c1"># GOOD - Always returns something</span>
<span class="k">def</span> <span class="nf">safe</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;keyword&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>
    <span class="k">return</span> <span class="n">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Not using temperature (low diversity):</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># GOOD - For best-of-n, I think it is a good idea to increase temperature to get some diversity.</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">num_responses</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">response_selector</span><span class="o">=</span><span class="n">pick_longest</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tutorial_5_moderators.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Moderators</p>
      </div>
    </a>
    <a class="right-next"
       href="tutorial_7_interview.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Interview-Based Personas</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-start">Quick Start</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-return-first-response-learn-the-mechanics">Example 1: Return First Response (Learn the Mechanics)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-return-longest-response">Example 2: Return Longest Response</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-a-real-world-problem-wikipedia-npov-with-verifiable-metrics">Example 3: [A real-world problem] Wikipedia NPOV with verifiable metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installation">Installation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#strategy-a-minimize-edit-distance">Strategy A: Minimize Edit Distance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#strategy-b-maximize-semantic-similarity">Strategy B: Maximize Semantic Similarity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#strategy-c-mixture-of-rewards">Strategy C: Mixture of Rewards</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-4-llm-as-judge-for-single-agents">Example 4: LLM-as-Judge for Single Agents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-5-llm-as-judge-in-debates">Example 5: LLM-as-Judge in Debates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pitfalls">Common Pitfalls</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Joshua Ashkinaze
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>