
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>plurals.agent &#8212; Plurals  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/plurals/agent';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Plurals  documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_1_core.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_2_quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_3_agents.html">Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_4_structures.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_5_moderators.html">Moderators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_6_best_of_n.html">Best-of-N Response Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_7_interview.html">Interview-Based Personas</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../agent.html">Agent Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deliberation.html">Deliberation Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../helpers.html">Helpers Module</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for plurals.agent</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">litellm</span> <span class="kn">import</span> <span class="n">completion</span>

<span class="kn">from</span> <span class="nn">plurals.helpers</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>

<span class="n">DEFAULTS</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="s2">&quot;instructions.yaml&quot;</span><span class="p">)</span>
<span class="n">DEFAULTS</span> <span class="o">=</span> <span class="n">strip_nested_dict</span><span class="p">(</span><span class="n">DEFAULTS</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_load_global_anes_data</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load global ANES data for the agent. As per codebook page 2 section 1, the cases that don&#39;t have weights are</span>
<span class="sd">    not meant for population inference.</span>

<span class="sd">    Here is the codebook url:</span>
<span class="sd">    https://electionstudies.org/wp-content/uploads/2024/03/anes_pilot_2024_userguidecodebook_20240319.pdf</span>

<span class="sd">    Loads:</span>
<span class="sd">    - PERSONA_MAPPING: Mapping for converting dataset rows to persona descriptions.</span>
<span class="sd">    - DATASET: ANES dataset for persona and ideological queries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">PERSONA_MAPPING</span><span class="p">,</span> <span class="n">DATASET</span>
    <span class="n">PERSONA_MAPPING</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="s2">&quot;anes-mapping.yaml&quot;</span><span class="p">)</span>
    <span class="n">DATASET</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
            <span class="s1">&#39;data&#39;</span><span class="p">,</span>
            <span class="s1">&#39;anes_pilot_2024_20240319.csv&#39;</span><span class="p">),</span>
        <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">DATASET</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">DATASET</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2024</span> <span class="o">-</span> <span class="n">DATASET</span><span class="p">[</span><span class="s1">&#39;birthyr&#39;</span><span class="p">]</span>


<span class="n">_load_global_anes_data</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_PersonaStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for persona generation strategies&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">persona_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a persona description&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_row2persona</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">persona_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a dataset row into a persona description string&quot;&quot;&quot;</span>
        <span class="n">persona</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">persona_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;age&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bad_vals&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;bad_vals&#39;</span><span class="p">]):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recode_vals&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;recode_vals&#39;</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;recode_vals&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>

            <span class="n">clean_name</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">persona</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">clean_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">persona</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_RandomPersonaStrategy</span><span class="p">(</span><span class="n">_PersonaStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategy for generating random personas from ANES&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">persona_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">selected_row</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row2persona</span><span class="p">(</span><span class="n">selected_row</span><span class="p">,</span> <span class="n">persona_mapping</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_IdeologyPersonaStrategy</span><span class="p">(</span><span class="n">_PersonaStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategy for generating personas based on ideology&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ideology</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span> <span class="o">=</span> <span class="n">ideology</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">persona_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_data_by_ideology</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No data found satisfying conditions&quot;</span><span class="p">)</span>
        <span class="n">selected_row</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row2persona</span><span class="p">(</span><span class="n">selected_row</span><span class="p">,</span> <span class="n">persona_mapping</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_filter_data_by_ideology</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">ideology</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter the dataset based on ideology&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ideology</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;liberal&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ideo5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Liberal&#39;</span><span class="p">,</span> <span class="s1">&#39;Very liberal&#39;</span><span class="p">])]</span>
        <span class="k">elif</span> <span class="n">ideology</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;conservative&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ideo5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Conservative&#39;</span><span class="p">,</span> <span class="s1">&#39;Very conservative&#39;</span><span class="p">])]</span>
        <span class="k">elif</span> <span class="n">ideology</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;moderate&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ideo5&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Moderate&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">ideology</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;very liberal&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ideo5&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Very liberal&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">ideology</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;very conservative&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ideo5&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Very conservative&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_QueryPersonaStrategy</span><span class="p">(</span><span class="n">_PersonaStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategy for generating personas based on query string&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_str</span> <span class="o">=</span> <span class="n">query_str</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">persona_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No data found satisfying conditions&quot;</span><span class="p">)</span>
        <span class="n">selected_row</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">filtered_data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row2persona</span><span class="p">(</span><span class="n">selected_row</span><span class="p">,</span> <span class="n">persona_mapping</span><span class="p">)</span>


<div class="viewcode-block" id="Agent">
<a class="viewcode-back" href="../../agent.html#plurals.agent.Agent">[docs]</a>
<span class="k">class</span> <span class="nc">Agent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Agents are LLMs with customizable personas, who complete tasks with other Agents working together in Structures.</span>
<span class="sd">    Personas of Agents can be instantiated directly, null (i.e., default system prompt), or leverage external datasets</span>
<span class="sd">    like ANES for nationally-representative personas.</span>

<span class="sd">    The main attributes of the Agent class are:</span>

<span class="sd">    1. ``system_instructions``: Set either directly or through various persona methods.</span>

<span class="sd">    2. ``combination_instructions``: Dictates how Agents should combine previous responses with the current task.</span>

<span class="sd">    3. ``task``: The task (i.e., user prompt) that Agents respond to.</span>

<span class="sd">    Agents can be used alone or in conjunction with Structures to create multi-agent simulations.</span>

<span class="sd">    Args:</span>
<span class="sd">        task (Optional[str]): Description of the task for the agent to process. If the agent is part of a structure,</span>
<span class="sd">            and the task is provided to the structure, then the agent will inherit that task.</span>
<span class="sd">        combination_instructions (Optional[str]): Instructions for combining previous responses with the current</span>
<span class="sd">            task. If the agent is part of a structure and the combination_instructions are provided to the structure,</span>
<span class="sd">            then the agent will inherit those combination instructions. Must include a ${previous_responses}</span>
<span class="sd">            placeholder.</span>
<span class="sd">        ideology (Optional[str]): Ideological perspective to influence persona creation, supported values are</span>
<span class="sd">                                  [&#39;liberal&#39;, &#39;conservative&#39;, &#39;moderate&#39;, &#39;very liberal&#39;, &#39;very conservative&#39;].</span>
<span class="sd">        query_str (Optional[str]): Custom query string for filtering the ANES dataset according to specific criteria.</span>
<span class="sd">        model (str): The language model version to use for generating responses.</span>
<span class="sd">        system_instructions (Optional[str]): Overrides automated instructions with a custom set of directives for the</span>
<span class="sd">            model.</span>
<span class="sd">        persona_template (Optional[str]): Template string for constructing the persona. If passing your own, you must include a ${persona}</span>
<span class="sd">            placeholder. You can pass in the names of templates located in `instructions.yaml` [1]. If not supplied: When using an ANES-generated persona the `anes` template will be used.</span>
<span class="sd">            Otherwise, the `default` template will be used. Current templates: https://github.com/josh-ashkinaze/plurals/blob/main/plurals/instructions.yaml</span>
<span class="sd">        persona (Optional[str]): Direct specification of a persona description.</span>
<span class="sd">        kwargs (Optional[dict]): Additional keyword arguments for the model&#39;s completion function. These are provided by LiteLLM. Enter `help(litellm.completion)` for details. LiteLLM completion function: https://litellm.vercel.app/docs/completion/input#input-params-1</span>
<span class="sd">        num_responses (int): Number of responses to generate for each task. Currently not implemented.</span>
<span class="sd">        response_selector (Optional[callable]): Function to select the best response from multiple generated responses. Currently not implemented.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        persona_mapping (Optional[Dict[str, Any]]): Dictionary to map dataset rows to persona descriptions.</span>
<span class="sd">        data (pd.DataFrame): Loaded dataset for persona and ideological queries.</span>
<span class="sd">        system_instructions (Optional[str]): Final system instructions for the agent to follow. The system</span>
<span class="sd">            instructions can be set directly or generated from a persona-based method.</span>
<span class="sd">        original_task_description (str): The original, unmodified task description.</span>
<span class="sd">        current_task_description (str): Dynamically updated task description that may include prior responses.</span>
<span class="sd">        history (list): Chronological record of prompts, responses, and models used during the agent&#39;s operation.</span>
<span class="sd">        responses (list): List of responses generated by the agent (the same information can be accessed by history)</span>
<span class="sd">        prompts (list): List of prompts that generated the responses (the same information can be accessed by history)</span>
<span class="sd">        info (dict): Comprehensive attributes of the agent&#39;s current configuration and state.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Note that when used with Structures, the agent-level attribute values will override. Eg: If you set a task</span>
<span class="sd">        at an agent level and a Structure-level, the agent-level task will be used.</span>

<span class="sd">    **Examples:**</span>

<span class="sd">        **Using Agent without a structure**.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            task = &quot;Say hello&quot;</span>

<span class="sd">            a = agent(task=task)</span>
<span class="sd">            ans = a.process()</span>

<span class="sd">            pirate_agent = Agent(system_instructions=&quot;You are a pirate.&quot;, model=&#39;gpt-4o&#39;, task=task)</span>
<span class="sd">            pirate_hello = pirate_agent.process()</span>
<span class="sd">            pirate_goodybe = pirate_agent.process(task=&quot;Now say a heartfelt goodybe.&quot;)</span>

<span class="sd">        **Manual system instructions**: This allows you to set system instructions to whatever you would like. Also note</span>
<span class="sd">        that you can pass in additional kwargs to the model.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            agent = Agent(system_instructions=&quot;You are a predictable independent&quot;, model=&#39;gpt-4o&#39;,</span>
<span class="sd">                          kwargs={&#39;temperature&#39;: 0.1, &#39;max_tokens&#39;: 200})</span>

<span class="sd">        **No system instructions**: When no system instructions are inputted, agents will use default system instructions.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            agent = Agent(model=&#39;gpt-4o&#39;, kwargs={&#39;temperature&#39;: 1, &#39;max_tokens&#39;: 500})</span>

<span class="sd">        **Persona Template**: When using a persona method, the full system instructions are a combination of the</span>
<span class="sd">        persona and the `persona_template`---where the latter is a template string that includes a ${persona}</span>
<span class="sd">        placeholder. This gives more instructions to the model of how to enact the persona.</span>

<span class="sd">        Here is an example of using the `second_wave` persona template with a persona of &quot;a moderate voter from Michigan&quot;.</span>
<span class="sd">        You can see how the full system instructions are a combination of the two.</span>

<span class="sd">        .. code-block::</span>

<span class="sd">            second_wave_michigan = Agent(persona=&quot;a moderate voter from Michigan&quot;,</span>
<span class="sd">                persona_template=&quot;second_wave&quot;)</span>
<span class="sd">            print(second_wave_michigan.system_instructions)</span>

<span class="sd">        .. code-block:: text</span>

<span class="sd">            INSTRUCTIONS</span>
<span class="sd">            When answering questions or performing tasks, always adopt the following persona.</span>

<span class="sd">            PERSONA:</span>
<span class="sd">            a moderate voter from Michigan</span>

<span class="sd">            CONSTRAINTS</span>
<span class="sd">            - When answering, do not disclose your partisan or demographic identity in any way.</span>
<span class="sd">            - Think, talk, and write like your persona.</span>
<span class="sd">            - Use plain language.</span>
<span class="sd">            - Adopt the characteristics of your persona.</span>
<span class="sd">            - Be empathetic and compassionate.</span>
<span class="sd">            - Use narrative, rhetoric, testimony, storytelling and more emotional forms of communication instead of relying solely on facts. It is okay to deviate from relying solely on facts.</span>

<span class="sd">        Here is an example of using your own persona template with the appropriate ${persona} placeholder.</span>

<span class="sd">        .. code-block::</span>

<span class="sd">            agent = Agent(persona=&quot;a moderate voter from Michigan&quot;, persona_template=&quot;You are ${persona}.&quot;)</span>
<span class="sd">            print(agent.system_instructions)</span>
<span class="sd">            # You are a moderate voter from Michigan.</span>

<span class="sd">        We support several automatic ways of generating personas from American National Election Studies (ANES).</span>

<span class="sd">        **Ideology Matching (ANES Persona Method):** We support an ideology keyword that can be one of</span>
<span class="sd">        [&#39;very liberal&#39;, &#39;liberal&#39;, &#39;moderate&#39;, &#39;conservative&#39;, &#39;very conservative&#39;] where the &#39;veries&#39; are a</span>
<span class="sd">        subset of the normals. The below example will pick a random row from ANES where</span>
<span class="sd">        the citizen identifies as `very conservative` and use that as the `persona`. We always use appropriate sampling</span>
<span class="sd">        weights, so personas will be nationally representative.</span>

<span class="sd">        .. code-block::</span>

<span class="sd">            agent = Agent(ideology=&quot;very conservative&quot;, model=&#39;gpt-4o&#39;, task=task)</span>
<span class="sd">            print(agent.persona)</span>
<span class="sd">            print(agent.system_instructions)</span>

<span class="sd">        .. code-block:: text</span>

<span class="sd">            Your age is 57. Your education is high school graduate. Your gender is man. Your race is hispanic. Politically, you identify as a(n) republican. Your ideology is very conservative. Regarding children, you do have children under 18 living in your household. Your employment status is full-time. Your geographic region is the northeast. You live in a suburban area. You live in the state of new york.</span>

<span class="sd">        .. code-block:: text</span>

<span class="sd">            INSTRUCTIONS</span>
<span class="sd">            When answering questions or performing tasks, always adopt the following persona.</span>

<span class="sd">            PERSONA:</span>
<span class="sd">            Your age is 57. Your education is high school graduate. Your gender is man. Your race is hispanic. Politically, you identify as a(n) republican. Your ideology is very conservative. Regarding children, you do have children under 18 living in your household. Your employment status is full-time. Your geographic region is the northeast. You live in a suburban area. You live in the state of new york.</span>

<span class="sd">            CONSTRAINTS</span>
<span class="sd">            - When answering, do not disclose your partisan or demographic identity in any way.</span>
<span class="sd">            - Think, talk, and write like your persona.</span>
<span class="sd">            - Use plain language.</span>
<span class="sd">            - Adopt the characteristics of your persona.</span>
<span class="sd">            - Do not be overly polite or politically correct.</span>


<span class="sd">        **Random Nationally Representative Personas (ANES Persona Method)**: If you make persona== &#39;random&#39; then we will</span>
<span class="sd">        randomly sample a row</span>
<span class="sd">        from ANES and use that as the persona.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            agent = Agent(persona=&#39;random&#39;, model=&#39;gpt-4o&#39;, task=task)</span>

<span class="sd">        **Pandas Query String (ANES Persona Method):** If you want to get more specific, you can pass in a query string</span>
<span class="sd">        that will be used to filter the ANES dataset. Again, all ANES methods use sampling weights to ensure national representativeness.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            agent = Agent(query_str=&quot;inputstate==&#39;West Virginia&#39; &amp; ideo5==&#39;Very conservative&#39;&quot;, model=&#39;gpt-4o&#39;, task=task)</span>


<span class="sd">        **Here is how to inspect exactly what is going on with Agents.** You can view an Agent&#39;s responses,</span>
<span class="sd">        the agent&#39;s `history` (prompts + responses), and `info`---which is a dictionary of the agent&#39;s attributes (such as system instructions).</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from plurals.agent import Agent</span>
<span class="sd">            a = Agent(ideology=&quot;very conservative&quot;, model=&#39;gpt-4o&#39;, task=&quot;A task here&quot;)</span>
<span class="sd">            a.process()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">combination_instructions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">ideology</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">query_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
                 <span class="n">system_instructions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">persona_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">persona</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">num_responses</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">response_selector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span> <span class="o">=</span> <span class="n">system_instructions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combination_instructions</span> <span class="o">=</span> <span class="n">combination_instructions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persona_mapping</span> <span class="o">=</span> <span class="n">PERSONA_MAPPING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_description</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persona</span> <span class="o">=</span> <span class="n">persona</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span> <span class="o">=</span> <span class="n">ideology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DATASET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_str</span> <span class="o">=</span> <span class="n">query_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_task_description</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">DEFAULTS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_default_persona_template</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">persona_template</span> <span class="k">else</span> <span class="n">persona_template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_templates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_system_instructions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_system_instructions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_responses</span> <span class="o">=</span> <span class="n">num_responses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_selector</span> <span class="o">=</span> <span class="n">response_selector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_best_response_selector</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_set_system_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Users can directly pass in system_instructions. Or, we can generate system instructions by combining a</span>
<span class="sd">        persona_template and a persona.</span>

<span class="sd">        In these two cases, persona_template does not do anything since system_instructions is set directly or is None.</span>
<span class="sd">        - If system_instructions is already provided, we don&#39;t need to do anything since system_instructions is</span>
<span class="sd">        already set.</span>
<span class="sd">        - If neither system_instructions, persona, ideology, nor query_str is provided (default) set</span>
<span class="sd">        system_instructions to None.</span>

<span class="sd">        Otherwise, we generate system instructions using a persona:</span>
<span class="sd">        - If persona is directly provided, use this.</span>
<span class="sd">        - If persona is &quot;random&quot; generate a random ANES persona</span>
<span class="sd">        - If persona is not already provided, generate it. This can be generated from a `query_str` or from `ideology`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If system_instructions is already provided, we don&#39;t need to do</span>
        <span class="c1"># anything</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># If system_instructions, persona, ideology, nor query_str is provided,</span>
        <span class="c1"># set system_instructions to None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="c1"># If persona is already provided, use it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persona</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span>

        <span class="c1"># If persona is &quot;random&quot; generate a random ANES persona</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persona</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_persona</span><span class="p">()</span>

        <span class="c1"># If persona is not already provided, generate it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persona</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_persona</span><span class="p">()</span>

        <span class="c1"># Use the persona_template to create system_instructions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;persona_template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span> <span class="o">=</span> <span class="n">SmartString</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">persona</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">persona</span><span class="p">,</span>
            <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_description</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_generate_persona</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a persona using the appropriate strategy&quot;&quot;&quot;</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_persona_strategy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">strategy</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona_mapping</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_persona_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_PersonaStrategy</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the appropriate persona generation strategy&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_RandomPersonaStrategy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_IdeologyPersonaStrategy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ideology</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_QueryPersonaStrategy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_str</span><span class="p">)</span>

<div class="viewcode-block" id="Agent.process">
<a class="viewcode-back" href="../../agent.html#plurals.agent.Agent.process">[docs]</a>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">previous_responses</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the task, optionally building upon a previous response. If you pass in a task, it will replace the</span>
<span class="sd">        Agent&#39;s initialized task description. If you pass in a previous responses, it will be incorporated into the task</span>
<span class="sd">        description if ``combination_instructions`` have not been set.</span>

<span class="sd">        Args:</span>
<span class="sd">            previous_responses (str): The previous responses to incorporate.</span>
<span class="sd">            task (Optional[str]): The task description to process. If not provided, the agent will use its current task.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: The response from the LLM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">previous_responses</span><span class="p">:</span>
            <span class="c1"># Update the task description with the previous responses</span>
            <span class="n">combined_responses</span> <span class="o">=</span> <span class="n">SmartString</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">combination_instructions</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">previous_responses</span><span class="o">=</span><span class="n">previous_responses</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span> <span class="o">=</span> <span class="n">SmartString</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">combined_responses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span> <span class="o">=</span> <span class="n">SmartString</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">original_task_description</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">combined_responses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_task_description</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method to interact with the LLM API and get a response.</span>

<span class="sd">        If num_responses &gt; 1, generates multiple responses and uses response_selector to pick one.</span>

<span class="sd">        Args:</span>
<span class="sd">            task (str): The task description to send to the LLM.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: The selected response from the LLM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">}]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">}]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">all_responses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_responses</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">completion</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
                <span class="n">all_responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_responses</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">selected_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_selector</span><span class="p">(</span><span class="n">all_responses</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_response</span> <span class="o">=</span> <span class="n">all_responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">prompts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span> <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;system&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span> <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="n">history_entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;prompts&#39;</span><span class="p">:</span> <span class="n">prompts</span><span class="p">,</span>
                <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">selected_response</span><span class="p">,</span>
                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_responses</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">history_entry</span><span class="p">[</span><span class="s1">&#39;all_responses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_responses</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_entry</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">selected_response</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching response from LLM: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_validate_system_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the system instructions arguments.</span>

<span class="sd">        Errors raised if:</span>
<span class="sd">        - ideology or query_str is passed in without data and persona_mapping</span>
<span class="sd">        - system_instructions is passed in with persona or persona_template</span>
<span class="sd">        - ideology or query_str is passed in with persona</span>
<span class="sd">        - ideology is passed in and it&#39;s not in  [&#39;liberal&#39;, &#39;conservative&#39;, &#39;moderate&#39;, &#39;very liberal&#39;,</span>
<span class="sd">        &#39;very conservative&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_str</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona_mapping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;If you use either `ideology` or &quot;</span>
                                                                                <span class="s2">&quot;`query_str` you need to provide both &quot;</span>
                                                                                <span class="s2">&quot;a dataframe and a persona mapping to &quot;</span>
                                                                                <span class="s2">&quot;process rows of the dataframe.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ideology</span><span class="p">),</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_str</span><span class="p">),</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">persona</span><span class="p">),</span>
                 <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;You can only pass in one of ideology, query_str, system_instructions, or persona&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span><span class="p">:</span>
            <span class="n">allowed_vals</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;liberal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;conservative&#39;</span><span class="p">,</span>
                <span class="s1">&#39;moderate&#39;</span><span class="p">,</span>
                <span class="s1">&#39;very liberal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;very conservative&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span> <span class="ow">in</span> <span class="n">allowed_vals</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Ideology has to be one of: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">allowed_vals</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_validate_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Errors raised if:</span>
<span class="sd">        - a user passes in persona_template but it does not contain a persona placeholder (so there is no way to</span>
<span class="sd">        format it)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span><span class="p">:</span>
            <span class="n">default_templates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;persona_template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">assert</span> <span class="s1">&#39;$</span><span class="si">{persona}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span> <span class="ow">in</span> <span class="n">default_templates</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s2">&quot;If you pass in a custom persona_template, it must contain a $</span><span class="si">{persona}</span><span class="s2"> placeholder or be one of the default templates:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">default_templates</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validate_best_response_selector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the best response selector function.</span>

<span class="sd">        Errors raised if:</span>
<span class="sd">        - response_selector is not callable when provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_responses</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If num_responses &gt; 1, you must provide a response_selector function&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_responses</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_responses must be at least 1&quot;</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An Agent&#39;s history</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of dictionaries containing the prompts, responses, and models used during the agent&#39;s operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Be aware: No Agent history was found since tasks have not been processed yet.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private property, mainly used for debugging and testing. It includes more than in the user-facing info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;original_task&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_task_description</span><span class="p">,</span>
            <span class="s2">&quot;current_task_description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span><span class="p">,</span>
            <span class="s2">&quot;system_instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span><span class="p">,</span>
            <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
            <span class="s2">&quot;persona&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span><span class="p">,</span>
            <span class="s2">&quot;ideology&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span><span class="p">,</span>
            <span class="s2">&quot;query_str&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_str</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s2">&quot;persona_template&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span><span class="p">,</span>
            <span class="s2">&quot;combination_instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_instructions</span><span class="p">,</span>
            <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Info of Agent</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Comprehensive attributes of the agent&#39;s current configuration and state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;original_task&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_task_description</span><span class="p">,</span>
            <span class="s2">&quot;current_task_description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span><span class="p">,</span>
            <span class="s2">&quot;system_instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span><span class="p">,</span>
            <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
            <span class="s2">&quot;persona&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span><span class="p">,</span>
            <span class="s2">&quot;persona_template&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona_template</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;combination_instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">combination_instructions</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">responses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The responses to prompts</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of responses generated by the agent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Be aware: No Agent history was found since tasks have not been processed yet.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;response&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">))]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The prompts that generated the responses</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of prompts that generated the responses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Be aware: No Agent history was found since tasks have not been processed yet.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;prompts&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">))]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="Agent.set_task">
<a class="viewcode-back" href="../../agent.html#plurals.agent.Agent.set_task">[docs]</a>
    <span class="k">def</span> <span class="nf">set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the task description for the agent to process.</span>

<span class="sd">        Args:</span>
<span class="sd">            task (str): The new task description.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Sets:</span>
<span class="sd">            self.original_task_description: The original, unmodified task description.</span>
<span class="sd">            self.current_task_description: Dynamically updated task description that may include prior responses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_task_description</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_task_description</span> <span class="o">=</span> <span class="n">task</span></div>


<div class="viewcode-block" id="Agent.is_anes_persona">
<a class="viewcode-back" href="../../agent.html#plurals.agent.Agent.is_anes_persona">[docs]</a>
    <span class="k">def</span> <span class="nf">is_anes_persona</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the persona is an ANES-generated persona.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideology</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">persona</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Agent.handle_default_persona_template">
<a class="viewcode-back" href="../../agent.html#plurals.agent.Agent.handle_default_persona_template">[docs]</a>
    <span class="k">def</span> <span class="nf">handle_default_persona_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The default persona template should be `default&#39; if not ANES persona else &#39;anes&#39;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_anes_persona</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;anes&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;default&quot;</span></div>
</div>

</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Joshua Ashkinaze
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>